name: Build and upload binaries to release

on:
  repository_dispatch:
    types: [tag-created]

jobs:
  release:
    name: Build and Release
    runs-on: ${{ matrix.triple.os }}
    strategy:
      matrix:
        triple:
          # x86_64 linux, bin
          - { 
              os: ubuntu-latest,
              target: "x86_64-unknown-linux-gnu",
              cross: false,
              artifact_name: cli,
              asset_name: cli-x86_64-unknown-linux-gnu
            }
          # x86_64 linux, lib
          - { 
              os: ubuntu-latest,
              target: "x86_64-unknown-linux-gnu",
              cross: false,
              artifact_name: libclient.so,
              asset_name: libclient-x86_64-unknown-linux-gnu.so
            }
          # aarch64 android, lib
          - {
              os: ubuntu-latest,
              target: aarch64-linux-android,
              cross: true,
              artifact_name: libclient.a,
              asset_name: libclient-aarch64-linux-android.a
            }
          # armv7 android, lib
          - {
              os: ubuntu-latest,
              target: armv7-linux-androideabi,
              cross: true,
              artifact_name: libclient.a,
              asset_name: libclient-armv7-linux-androideabi.a
            }
          # aarch64 ios, lib
          - {
              os: macos-latest,
              target: aarch64-apple-ios,
              cross: false,
              artifact_name: libclient.a,
              asset_name: libclient-aarch64-apple-ios.a
            }
          # x86_64 ios, lib
          - {
              os: macos-latest,
              target: x86_64-apple-ios,
              cross: false,
              artifact_name: libclient.a,
              asset_name: libclient-x86_64-apple-ios.a
            }
          # universal ios, lib
          - {
              os: macos-latest,
              target: universal,
              cross: false,
              artifact_name: libclient.a,
              asset_name: libclient-universal-ios.a
            }
          # we can add in this too if we have time "x86_64-apple-darwin"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build project
        # we can add in this too if we have time "x86_64-apple-darwin"
        run: |
          TARGET=${{ matrix.triple.target }}
          case $TARGET in
            "aarch64-linux-android" | "armv7-linux-androideabi")
              sudo apt-get install musl-tools libssl-dev
              CURRENT=`pwd`
              mkdir -p $HOME/usr/local
              cd $HOME/usr/local
              rustup target add $TARGET
              if [ "$TARGET" == "armv7-linux-androideabi" ]
              then
                TARGET_SHORT_NAME=armeabi-v7a
                GMP_TARGET="armv7a-linux-androideabi"
                wget https://github.com/ezsyfi/gmp/releases/download/6.2.1/${GMP_TARGET}.zip
                unzip ${GMP_TARGET}.zip
                cd $CURRENT
                mkdir -p target/${TARGET}/release/deps
                cp -rf $HOME/usr/local/${GMP_TARGET}/lib/libgmp* target/${TARGET}/release/deps/
              else
                TARGET_SHORT_NAME=aarch64-linux-android
                wget https://github.com/ezsyfi/gmp/releases/download/6.2.1/${TARGET}.zip
                unzip ${TARGET}.zip
                cd $CURRENT
                mkdir -p target/${TARGET}/release/deps
                cp -rf $HOME/usr/local/${TARGET}/lib/libgmp* target/${TARGET}/release/deps/
              fi
              cargo install cargo-ndk
              cargo ndk --target $TARGET_SHORT_NAME build --lib --bin cli --release
              ;;
            "aarch64-apple-ios" | "x86_64-apple-ios")
              rustup target add $TARGET
              cargo install cargo-lipo
              cargo lipo --targets $TARGET --release
              ;;
            "universal")
              rustup target add aarch64-apple-ios x86_64-apple-ios
              cargo install cargo-lipo
              cargo lipo --release
              ;;
            *)
              sudo apt-get install musl-tools libssl-dev
              rustup target add $TARGET
              cargo build --target $TARGET --lib --bin cli --release
              ;;
          esac
          echo "See our release files"
          ls -la target/$TARGET/release
      - name: Upload binary to release
        uses: svenstaro/upload-release-action@v1-release
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: target/${{ matrix.triple.target }}/release/${{ matrix.triple.artifact_name }}
          asset_name: ${{ matrix.triple.asset_name }}
          tag: ${{ github.event.client_payload.new_version }}
          overwrite: true